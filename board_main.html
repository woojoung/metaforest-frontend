<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <!-- <link rel="stylesheet" type="text/css" href="css/style.css" /> -->
    <title></title>
    <style>
      #pagingul {
          text-align: center;
          display: inline-block;
          border: 1px solid #ccc;
          border-right: 0;
          list-style-type: none;
          padding-left: 0;
      }

      #pagingul li {
          text-align: center;
          float: left;
      }

      #pagingul li a {
          display: block;
          font-size: 14px;
          padding: 9px 12px;
          border-right: solid 1px #ccc;
          box-sizing: border-box;
      }

      #pagingul li.on {
          background: #eda712;
      }

      #pagingul li.on a {
          color: #fff;
      }
    </style>
  </head>
  <body>
    <div id="board_area">

      <h1>공지사항</h1>
      <div>
        <ul class="nav">
            <li style="display:inline"><a href="./board_main.html">공지사항</a></li>
            <li style="display:inline"><a href="./board_event.html">이벤트</a></li>
            <li style="display:inline"><a href="./board_manual.html">이용매뉴얼</a></li>
            <li style="display:inline"><a href="./board_faq.html">문의사항</a></li>
          </ul>
      </div>
      
      <div id="search_box">
        <form action="" method="">
          <select name="catgo">
            <option value="starter" selected>선택</option>
            <option value="title">제목</option>
            <option value="name">글쓴이</option>
            <option value="content">내용</option>
          </select>
          <input type="text" name="search" size="30" required="required" /> <button>검색</button>
        </form>
      </div>

    </br>

    <section id="section9">
      <table class="list-table">
        <thead>
            <tr>
              <th><input class="overall-checkbox" type="checkbox"></th>
              <th width="70">번호</th>
              <th width="300">제목</th>
              <th width="120">글쓴이</th>
            </tr>
        </thead>
        <tbody id="table1">
        </tbody>
  
      </table>
      <button type="button" class="delete-button" >선택 삭제</button>
      <button type="button" onclick="location.href='board_write.html' ">등록</button>
    </section>

    </br>

     <!---paging number --->
     <ul id="pagingul">
     </ul>

  </div>
    <script src='./tools/cfg.js'></script>
    <script src='./tools/enums.js'></script>
    <script src='./tools/libs.js'></script>
    <script src='./tools/md5.js'></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <script>
      'use strict'
      var myArray = [ 
        {noticeId : 1, title : '공지사항입니다.', name : '관리자'}, 
        {noticeId : 2, title : '집단상담은 어떻게 진행되나요?', name : '관리자'}, 
        {noticeId : 3, title : '플랫폼은 무료인가요?', name : '관리자'}, 
      ];

      // buildTable(myArray); 
      
      function buildTable(data) { 
        let table = document.getElementById('table1');
        table.innerHTML = '';
        let row = '';
        for (var i=0; i < data.length; i++) { 
          row = `<tr><td class="center"><input type="checkbox" value="${data[i].noticeId}" /></td><td style="text-align:center">${data[i].noticeId}</td> <td style="text-align:left">${data[i].title}</td> <td style="text-align:center">${data[i].adminId}</td> </tr>`;
          table.innerHTML += row 
        } 
      }

    </script>

    

    <script>
      /* 체크박스 전체선택, 전체해제 */
      let section = document.querySelector('#section9')
      let noticeList = section.querySelector('.list-table')
      let tableBody = noticeList.querySelector('tbody')
      let allCheckbox = section.querySelector('.overall-checkbox')
      let deleteButton = section.querySelector('.delete-button')
      // select all
      allCheckbox.onchange = function () {
        let temp = tableBody.querySelectorAll('input[type="checkbox"]')
        if (allCheckbox.checked === true) {
          for (let i=0;i<temp.length;i++) {
            temp[i].checked = true
          }
        } else {
          for (let i=0;i<temp.length;i++) {
            temp[i].checked = false
          }
        }
      }
      // delete selected row
      deleteButton.onclick = async function () {
        let deleteTemp = tableBody.querySelectorAll('input[type="checkbox"]:checked')
        console.log(deleteTemp)
        let checkBoxNum = []
        for (let i=0;i<deleteTemp.length;i++) {
          checkBoxNum.push(deleteTemp[i].value)
        }
        console.log(checkBoxNum)
        const response = await axios.post('http://127.0.0.1:7071/notice', {
          msgType: eApiMessageType.ADMIN_DELETE_NOTICE_REQ,
          data: {
            noticeIds : checkBoxNum
          }
        }, {withCredentials: true})

        console.log(response)
      }

    </script>

    <script>
      'use strict'
      const apiGetList = async (_perPage) => {
        try {
          const _response = await axios.post('http://127.0.0.1:7071/notice', {
            msgType: eApiMessageType.USER_GET_LIST_NOTICE_REQ,
            data: {
              page: _perPage
            }
          }, {withCredentials: true})

          let response = {}
          Object.assign(response, _response)

          console.log(response)
          console.log(response.data)

          if (response.status !== 200) {
            console.log(response)
            return
          }
          globalCurrentPage = _perPage;
          paging(totalData, _perPage);
          buildTable(response.data)

        } catch (err) {
          console.error(err)
        }
      };

    </script>

    <script>
      'use strict'

      let totalData; // 총 데이터 수 
      let dataPerPage = 10;
      let pageCount = 5;
      let globalCurrentPage = 1; // 현재 페이지


      window.onload = function () {
        apiGetCount()
      }
      const apiGetCount = async () => {
        try {
          const _response = await axios.post(apiUrl +'notice', {
            msgType: eApiMessageType.USER_GET_COUNT_NOTICE_REQ,
            data: {}
          }, {withCredentials: true})

          let response = {}
          Object.assign(response, _response)

          console.log(response)
          console.log(response.data)

          totalData = response.data.length
          console.log("totalData : " + totalData);

          await paging(totalData, globalCurrentPage);
          await apiGetList(globalCurrentPage);

        } catch (err) {
          console.error(err)
        }
      };

      

      // paging 함수
      function paging(totalData, currentPage) {

        console.log("currentPage : " + currentPage);

        let totalPage = Math.ceil(totalData / dataPerPage); // 총 페이지 수
        console.log("totalPage : " + totalPage);

        console.log("pageCount : " + pageCount);

        if (totalPage < pageCount) {
          pageCount = totalPage;
        }        

        let pageGroup = Math.ceil(currentPage / pageCount); // 페이지 그룹
        console.log("pageGroup : " + pageGroup);

        let last = pageGroup * pageCount // 화면에 보여질 마지막 페이지 번호
        console.log("last : " + last);

        if (last > totalPage) {
          last = totalPage;
        }

        let first = last - (pageCount - 1); // 화면에 보여질 첫번째 페이지 번호
        console.log("first : " + first);
        let next = last + 1;
        let prev = first - 1;

        let pageHtml = "";

        pageHtml += "<li><a class='pageIdx' href='#' id='first' onclick=apiGetList(" + (first.toString()) + ")> |< </a></li>";

        if (prev > 0) {
          pageHtml += "<li><a class='pageIdx' href='#' id='prev' onclick=apiGetList(" + (prev.toString()) + ")> < </a></li>";
        }

        // 페이징 번호 표시
        for (let i = first; i<=last; i++) {
          if(currentPage === i) {
            pageHtml += "<li class='on'><a class='pageIdx' href='#' onclick=apiGetList(" + (i.toString()) + ")>" + i + "</a></li>";
          } else {
            pageHtml += "<li class='on'><a class='pageIdx' href='#' onclick=apiGetList(" + (i.toString()) + ")>" + i + "</a></li>";
          }
        }

        if (last < totalPage) {
          pageHtml += "<li><a href='#' id='next' onclick=apiGetList(" + (next.toString()) + ")> > </a></li>";
        }

        pageHtml += "<li><a class='pageIdx' href='#' id='last' onclick=apiGetList(" + (last.toString()) + ")> >| </a></li>";

        document.querySelector('#pagingul').innerHTML = pageHtml;
      }


    </script>

</body>
</html>
