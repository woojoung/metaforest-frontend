<!DOCTYPE html>
<html lnag="ko">

<head>
    <meta charset="UTF-8">
    <title>메타포레스트 : 회원가입</title>

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="fonts/NexonLv2Gothic/nexonlv2gothic.css" rel="stylesheet">
    <link href="fonts/ProximaNova/proximanova.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=DM+Sans:400,400i,500,700&family=Raleway:wght@800&display=swap' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <!-- Favicons -->
	<link rel="shortcut icon" href="./img/favicon.ico">

    <!-- css-->
    <link rel="stylesheet" href="css/signup.css">

</head>

<body>
    <!-- header -->
    <div id="header">
        <h2 id="logo"><a href="" target="_blank" title=""><img src="/img/logo/logo_bk.png"></a>
        </h2>
    </div>


    <!-- wrapper -->
    <div id="wrapper">

        <!-- content-->
        <div id="content">

            <!-- ID -->
            <div>
                <h3 class="join_title">
                    <label for="id">아이디</label>
                </h3>
                <span class="box int_id">
                    <input type="text" id="id" class="int" maxlength="20" placeholder="이메일" required>

                </span>
                <span class="error_next_box"></span>
            </div>

            <!-- PW1 -->
            <div>
                <h3 class="join_title"><label for="pswd1">비밀번호</label></h3>
                <span class="box int_pass">
                    <input type="text" id="pswd1" class="int" maxlength="20" required>
                    <span id="alertTxt">사용불가</span>
                </span>
                <span class="error_next_box"></span>
            </div>

            <!-- PW2 -->
            <div>
                <h3 class="join_title"><label for="pswd2">비밀번호 재확인</label></h3>
                <span class="box int_pass_check">
                    <input type="text" id="pswd2" class="int" maxlength="20" required>
                </span>
                <span class="error_next_box"></span>
            </div>

            <!-- NAME -->
            <div>
                <h3 class="join_title"><label for="name">이름</label></h3>
                <span class="box int_name">
                    <input type="text" id="name" class="int" maxlength="20" required>
                </span>
                <span class="error_next_box"></span>
            </div>


            <!-- GENDER -->
            <div>
                <h3 class="join_title"><label for="gender">성별</label></h3>
                <span class="box gender_code">
                    <select id="gender" class="sel" required>
                        <option>선택</option>
                        <option value="M">남자</option>
                        <option value="F">여자</option>
                    </select>
                </span>
                <span class="error_next_box">필수 정보입니다.</span>
            </div>

            <!-- BIRTH -->
            <div>
                <h3 class="join_title"><label for="yy">생년월일</label></h3>

                <div id="bir_wrap">
                    <!-- BIRTH_YY -->
                    <div id="bir_yy">
                        <span class="box">
                            <input type="text" id="yy" class="int" maxlength="4" placeholder="년(4자)" required>
                        </span>
                    </div>

                    <!-- BIRTH_MM -->
                    <div id="bir_mm">
                        <span class="box">
                            <input type="text" id="mm" class="int" maxlength="2" placeholder="월" required>
                        </span>
                    </div>

                    <!-- BIRTH_DD -->
                    <div id="bir_dd">
                        <span class="box">
                            <input type="text" id="dd" class="int" maxlength="2" placeholder="일" required>
                        </span>
                    </div>

                </div>
                <span class="error_next_box"></span>
            </div>

            <!-- ACCESS LEVEL -->
            <div>
                <h3 class="join_title"><label for="accessLevel">서비스 유형</label></h3>
                <span class="box gender_code">
                    <select id="accessLevel" class="sel" required>
                        <option>선택</option>
                        <option value="10">내담자</option>
                        <option value="20">상담자</option>
                    </select>
                </span>
                <span class="error_next_box">필수 정보입니다.</span>
            </div>

            <!-- PARTNER -->
            <div>
                <h3 class="join_title"><label for="partner">기관 종류</label></h3>
                <span class="box gender_code">
                    <select id="partner" class="sel" required>
                        <option>선택</option>
                        <option value="1">고려대학교</option>
                        <option value="2">계명대학교</option>
                        <option value="3">울산대학교</option>
                        <option value="4">서울교육대학교</option>
                        <option value="5">세은심리상담연구소</option>
                    </select>
                </span>
                <span class="error_next_box">필수 정보입니다.</span>
            </div>

            <!-- PARTNER CODE -->
            <div>
                <h3 class="join_title"><label for="partner_code">기관 코드 (상담자 가입시)</label></h3>
                <span class="int_code">
                    <input type="text" id="partner_code" class="int" placeholder="">
                </span>
                <div id="code_btn">
                    <button type="button" id="btnSend" onclick="verifyPartnerCode()">
                        <span>기관코드 인증하기</span>
                    </button>
                </div>
            </div>


            <!-- EMAIL -->
            <div>
                <h3 class="join_title"><label for="email">이메일 주소</label></h3>
                <span class="int_email">
                    <input type="text" id="email" class="int" maxlength="100" placeholder="" required>
                    @
                    <select name="" id="email_addrs" required>
                        <option value="">선택</option>
                        <option value="gmail.com">gmail.com</option>
                        <option value="hanmail.net">hanmail.net</option>
                        <option value="hotmail.com">hotmail.com</option>
                        <option value="nate.com">nate.com</option>
                        <option value="naver.com">naver.com</option>
                        <option value="yahoo.com">yahoo.com</option>
                    </select>
                </span>
                <div id="email_btn">
                    <button type="button" id="btnSend" onclick="requestAuthCode()">
                        <span>인증번호 요청</span>
                    </button>
                </div>
                <span class="error_next_box">이메일 주소를 다시 확인해주세요.</span>
            </div>

            <!-- SECURITY CODE -->
            <div>
                <h3 class="join_title"><label for="email_code">인증번호 (5자리)</label></h3>
                <span class="int_code">
                    <input type="text" id="email_code" class="int" maxlength="5" placeholder="인증번호 입력하세요">
                </span>
                <div id="code_btn">
                    <button type="button" id="btnSend" onclick="verifyAuthCode()">
                        <span>확인</span>
                    </button>
                </div>
            </div>



            <!-- MOBILE -->
            <!-- <div>
                <h3 class="join_title"><label for="phoneNo">휴대전화</label></h3>
                <span class="box int_mobile">
                    <input type="tel" id="mobile" class="int" maxlength="16" placeholder="대한민국 +82" readonly="true">
                </span>
                </br>
                <div id="mobile_wrap">
                    <div id="mobile_digit">
                        <span class="box int_mobile">
                            <input type="tel" id="mobile" class="int" maxlength="16" placeholder="전화번호 입력">
                        </span>
                        <span class="error_next_box"></span>
                    </div>
                    <div id="mobile_btn">
                        <button type="button" id="btnSend">
                            <span>인증번호 받기</span>
                        </button>
                    </div>
                </div>
            </div> -->


            <!-- JOIN BTN-->
            <div class="btn_area">
                <button type="button" id="btnJoin" onclick="onSubmitForm()">
                    <span>가입하기</span>
                </button>
            </div>

            
        </div>
        <!-- content-->

    </div>
    <!-- wrapper -->
    <script src='./tools/cfg.js'></script>
    <script src='./tools/enums.js'></script>
    <script src='./tools/libs.js'></script>
    <script src='./tools/md5.js'></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        'use strict'
        async function verifyAuthCode() {
            let storageAuthCode = storageGet('authCode', '0')
            let emailAuthCode = document.getElementById("email_code").value

            if (storageAuthCode != emailAuthCode) {
                alert("storageAuthCode != emailAuthCode")
                return
            }

            storageSet('isVerifiedAuthCode', 'Y')
            alert('인증번호 확인')
        }

        async function verifyPartnerCode() {
            let partnerId = document.getElementById("partner").value
            let partnerCode = document.getElementById("partner_code").value

            let apiRequest = {
                msgType: eApiMessageType.USER_VERIFY_PARTNER_CODE_REQ,
                data: {
                    partnerId: partnerId,
                    code: partnerCode,
                }
            }

            const _response = await axios.post(apiUrl+'partner/verify', apiRequest, {
                withCredentials: true
            })

            let response = {}
            Object.assign(response, _response)

            console.log(response)
            console.log(response.data)

            if (response.status !== eHttpStatus.ok) {
                alert('잘못된 기관 코드 입니다.')
                return
            }

            storageSet('isVerifiedPartnerCodeCode', 'Y')
            alert('기관 코드 확인')
        }

    </script>

    <script>
        'use strict'
        async function requestAuthCode() {
            let email = document.getElementById("email").value
            let emailAddress = document.getElementById("email_addrs")
            let emailAddressValue = emailAddress.options[emailAddress.selectedIndex].value

            if (email === "") {
                alert("이메일 주소를 입력하세요")
                return
            }

            if (emailAddressValue === "") {
                alert("이메일 주소를 입력하세요")
                return
            }

            let sendEmail = [email, emailAddressValue].join('@')

            if (!emailCheck(sendEmail)) {
                alert("wrong email address")
                return
            }

            let apiRequest = {
                msgType: eApiMessageType.USER_SIGNUP_AUTHCODE_REQ,
                data: {
                    email: sendEmail,
                }
            }

            const _response = await axios.post(apiUrl+'auth/signup', apiRequest, {
                withCredentials: true
            })

            let response = {}
            Object.assign(response, _response)

            console.log(response)
            console.log(response.data)

            storageSet('authCode', response.data.authCode.toString())
        }
    </script>

    <script>
        'use strict'
        async function onSubmitForm() {
            // let accountId = document.getElementById("id").value
            let userNickname = document.getElementById("name").value

            let email = document.getElementById("email").value
            let emailAddress = document.getElementById("email_addrs")
            let emailAddressValue = emailAddress.options[emailAddress.selectedIndex].value

            let gender = document.getElementById("gender")
            let genderValue = gender.options[gender.selectedIndex].value

            let passwd = document.getElementById("pswd1").value
            let passwd2 = document.getElementById("pswd2").value

            let birthYear = document.getElementById("yy").value
            let birthMonth = document.getElementById("mm").value
            let birthDay = document.getElementById("dd").value

            let accessLevel = document.getElementById("accessLevel").value

            if (email === "" && passwd === "" && userNickname === "" && passwd2 === "") {
                alert("항목을 모두 입력해주세요.")
                return
            }

            let sendEmail = [email, emailAddressValue].join('@')
            let birth = [birthYear, birthMonth, birthDay].join('-')

            if (!emailCheck(sendEmail)) {
                alert("유효한 이메일 주소가 아닙니다.");
                return
            }

            // md5 passwd 
            if (passwd !== passwd2) {
                alert("비밀번호가 일치하지 않습니다. ");
                return
            }

            let isVerifiedAuthCode = storageGet('isVerifiedAuthCode', 'N');
            if (isVerifiedAuthCode !== 'Y') {
                alert("이메일 인증이 필요합니다.");
                return
            }

            let isVerifiedPartnerCode = storageGet('isVerifiedPartnerCode', 'N');

            if (parseInt(accessLevel) !== 10) {

                if (isVerifiedPartnerCode !== 'Y') {
                    alert("기관 인증이 필요합니다.");
                    return
                }
                accessLevel = 20;
            }

            const hexMd5 = hex_md5(sendEmail + hex_md5(passwd))

            let apiRequest = {
                msgType: eApiMessageType.USER_SIGNUP_REQ,
                data: {
                    // accountId: accountId,
                    userNickname: userNickname,
                    profileImageUrl: '',
                    email: sendEmail,
                    password: hexMd5,
                    gender: genderValue,
                    birth: birth,
                    md5Mobile: '',
                    accessLevel: accessLevel
                }
            }

            const _response = await axios.post(apiUrl+'auth/signup', apiRequest, {
                withCredentials: true
            })

            let response = {}
            Object.assign(response, _response)

            console.log(response)
            console.log(response.data)

            // if (response.errCode !== eHttpStatus.ok) {
            //     alert(response.message) 
            //     return
            // }
            // window.location.href = "https://metaforest.us/login.html"
            location.href = "./login.html"
        }
    </script>
</body>

</html>